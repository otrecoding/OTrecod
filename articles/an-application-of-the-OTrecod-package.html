<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>an-application-of-the-OTrecod-package • OTrecod</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="an-application-of-the-OTrecod-package">
<meta property="og:description" content="OTrecod">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">OTrecod</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/an-application-of-the-OTrecod-package.html">an-application-of-the-OTrecod-package</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="an-application-of-the-OTrecod-package_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>an-application-of-the-OTrecod-package</h1>
            
      
      
      <div class="hidden name"><code>an-application-of-the-OTrecod-package.Rmd</code></div>

    </div>

    
    
<div id="package-installation" class="section level2">
<h2 class="hasAnchor">
<a href="#package-installation" class="anchor"></a>Package installation</h2>
<p>If the package <strong>OTrecod</strong> is not installed in their current R versions, users can install it by following the standard instruction:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"OTrecod"</span><span class="op">)</span></code></pre></div>
<p>Each time an R session is opened, the <strong>OTrecod</strong> library must be loaded with:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">OTrecod</span><span class="op">)</span></code></pre></div>
<p>Moreover, the development version of <strong>OTrecod</strong> can be installed actually from [GitHub][gh] with:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Install development version from GitHub</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"otrecoding/OTrecod"</span><span class="op">)</span></code></pre></div>
<p> </p>
</div>
<div id="i--the-context" class="section level2">
<h2 class="hasAnchor">
<a href="#i--the-context" class="anchor"></a>I. The context</h2>
<p align="justify">
This vignette illustrates how to use the tools contained in the <strong>OTrecod</strong> package to solve a variable recoding problem frequently encountered in the context of data fusion. For more details about the theory of the algorithms used in the functions <strong>OT_outcome</strong> and **OT_joint* of the package, user can consult (1),(2) and their respective documentations.
</p>
<p align="justify">
For this example, we have transformed an available database called <em>samp.A</em> from the <strong>StatMatch</strong> package (see (3) and <code><a href="https://rdrr.io/pkg/StatMatch/man/samp.A.html">?samp.A</a></code> for more details). The <em>samp.A</em> database provides a limited number of variables observed at persons levels among those usually collected in the <em>European Union Statistics on Income and Living Conditions Survey</em> (the EU–SILC survey). In this database, the variable <em>c.neti</em> is a factor that corresponds to the persons net income categorized in 7 ordered classes of thousand of Euros whose distribution follows.
</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">StatMatch</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">samp.A</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">samp.A</span><span class="op">)</span>
<span class="co">#&gt; [1] 3009   13</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">samp.A</span><span class="op">)</span>
<span class="co">#&gt;        HH.P.id area5 urb hsize hsize5 age    c.age sex marital edu7 n.income</span>
<span class="co">#&gt; 21384 10149.01    NE   1     1      1  85 (64,104]   2       3    3     1677</span>
<span class="co">#&gt; 35973 17154.02    NE   1     2      2  78 (64,104]   1       2    3    13520</span>
<span class="co">#&gt; 11774  5628.01    NO   2     1      1  48  (44,54]   1       3    3    20000</span>
<span class="co">#&gt; 32127 15319.01     S   1     2      2  78 (64,104]   1       2    1    12428</span>
<span class="co">#&gt; 6301   2973.05     S   2     5    &gt;=5  17  [16,34]   1       1    1        0</span>
<span class="co">#&gt; 12990  6206.02     C   2     2      2  28  [16,34]   2       2    5        0</span>
<span class="co">#&gt;         c.neti        ww</span>
<span class="co">#&gt; 21384   (0,10] 3591.8939</span>
<span class="co">#&gt; 35973  (10,15]  415.1592</span>
<span class="co">#&gt; 11774  (15,20] 2735.4029</span>
<span class="co">#&gt; 32127  (10,15] 1239.5086</span>
<span class="co">#&gt; 6301  (-Inf,0] 5362.7588</span>
<span class="co">#&gt; 12990 (-Inf,0] 2077.7137</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">samp.A</span><span class="op">$</span><span class="va">c.neti</span><span class="op">)</span>   <span class="co"># Repartition of c.neti in the sample</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  (-Inf,0]    (0,10]   (10,15]   (15,20]   (20,25]   (25,35] (35, Inf] </span>
<span class="co">#&gt;       564       671       541       500       307       272       154</span></code></pre></div>
<p align="justify">
</p>
<p>To construct a standard recoding problem in data fusion, the <em>samp.A</em> database has been transformed:</p>
<ul>
<li>From the <em>c.neti</em> variable, we built a variable called <em>c.neti.bis</em> that corresponds to a second encoding of the persons net income now coded in 4 ordered levels (1: by grouping the first two levels of <em>c.neti</em>, 2: by grouping the two subsequent levels of <em>c.neti</em>, 3: by grouping the last two levels).</li>
<li>To improve the running time of the example, we only kept the first 350 subjects (rows) of <em>samp.A</em>.</li>
<li>This new sample has been divided in two distinct subsamples called <em>data1</em> (200 rows: subjects 1 to 200) and <em>data2</em> (150 rows: sujects 201 to 350).</li>
<li>The <em>c.neti.bis</em> variable has been excluded from <em>data1</em> and respectively <em>c.neti</em> have been excluded from <em>data2</em>.</li>
<li>Among the other variables, a random subset of them have been assigned in each database.</li>
</ul>
The R code related to these transformations was:

<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">c.neti</span>            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">samp.A</span><span class="op">$</span><span class="va">c.neti</span><span class="op">)</span>
<span class="va">samp.A</span><span class="op">$</span><span class="va">c.neti.bis</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">c.neti</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>,<span class="fl">1</span>, 
                              <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">c.neti</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">4</span><span class="op">)</span>,<span class="fl">2</span>, 
                              <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">c.neti</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">6</span><span class="op">)</span>,<span class="fl">3</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> 
<span class="va">data1</span> <span class="op">=</span> <span class="va">samp.A</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">200</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">5</span>,<span class="fl">7</span><span class="op">:</span><span class="fl">9</span>,<span class="fl">12</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data1</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">=</span> <span class="st">"age"</span> 
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data1</span><span class="op">)</span>
<span class="co">#&gt;       area5 urb hsize5      age sex marital   c.neti        ww</span>
<span class="co">#&gt; 21384    NE   1      1 (64,104]   2       3   (0,10] 3591.8939</span>
<span class="co">#&gt; 35973    NE   1      2 (64,104]   1       2  (10,15]  415.1592</span>
<span class="co">#&gt; 11774    NO   2      1  (44,54]   1       3  (15,20] 2735.4029</span>
<span class="co">#&gt; 32127     S   1      2 (64,104]   1       2  (10,15] 1239.5086</span>
<span class="co">#&gt; 6301      S   2    &gt;=5  [16,34]   1       1 (-Inf,0] 5362.7588</span>
<span class="co">#&gt; 12990     C   2      2  [16,34]   2       2 (-Inf,0] 2077.7137</span>
<span class="va">data2</span> <span class="op">=</span> <span class="va">samp.A</span><span class="op">[</span><span class="fl">201</span><span class="op">:</span><span class="fl">350</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">5</span><span class="op">:</span><span class="fl">6</span>,<span class="fl">8</span><span class="op">:</span><span class="fl">11</span>,<span class="fl">13</span><span class="op">:</span><span class="fl">14</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data2</span><span class="op">)</span>
<span class="co">#&gt;       urb hsize5 age sex marital edu7 n.income       ww c.neti.bis</span>
<span class="co">#&gt; 39565   3      2  81   2       2    1     6448 1129.274          1</span>
<span class="co">#&gt; 36490   1    &gt;=5  48   1       3    2    16423 3082.331          2</span>
<span class="co">#&gt; 27529   2      2  66   1       2    3    15600 2433.020          2</span>
<span class="co">#&gt; 201     2      4  26   1       1    3    12876 1869.286          2</span>
<span class="co">#&gt; 31375   2      2  53   1       2    3    25633 2125.361          3</span>
<span class="co">#&gt; 3226    3      1  45   2       3    3     2611 1855.230          1</span></code></pre></div>
<p align="justify">
</p>
<p>In conclusion, after transformation, we had:</p>
<ul>
<li>two separate databases <em>data1</em> and <em>data2</em> with no common subjet.</li>
<li>
<em>c.neti</em> and <em>c.neti.bis</em>: two variables that summarize a same information (the persons net income) encoded in two different scales in <em>data1</em> and <em>data2</em>.</li>
<li>a subset of shared variables between the two databases (variables with same labels in the 2 databases).</li>
<li>subsets of specific variables
</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data1</span><span class="op">$</span><span class="va">c.neti</span><span class="op">)</span>        <span class="co"># 7 levels in data1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  (-Inf,0]    (0,10]   (10,15]   (15,20]   (20,25]   (25,35] (35, Inf] </span>
<span class="co">#&gt;        37        40        34        49        18        13         9</span>

<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">data2</span><span class="op">$</span><span class="va">c.neti.bis</span><span class="op">)</span>    <span class="co"># 4 levels in data2</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  1  2  3  4 </span>
<span class="co">#&gt; 60 57 26  7</span>

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data1</span><span class="op">)</span>
<span class="co">#&gt; [1] "area5"   "urb"     "hsize5"  "age"     "sex"     "marital" "c.neti" </span>
<span class="co">#&gt; [8] "ww"</span>

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data2</span><span class="op">)</span>
<span class="co">#&gt; [1] "urb"        "hsize5"     "age"        "sex"        "marital"   </span>
<span class="co">#&gt; [6] "edu7"       "n.income"   "ww"         "c.neti.bis"</span>

<span class="fu"><a href="https://rdrr.io/r/base/sets.html">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data2</span><span class="op">)</span><span class="op">)</span>   <span class="co"># the susbet of a priori shared variables</span>
<span class="co">#&gt; [1] "urb"     "hsize5"  "age"     "sex"     "marital" "ww"</span></code></pre></div>
<strong>OBJECTIVE</strong>
<p align="justify">
<strong>Assuming that the encoding of <em>c.neti</em> is unknown for the subjects of <em>data2</em> and that the encoding of <em>c.neti.bis</em> is unknown for the subjects of <em>data1</em>, the functions of the OTrecod package solve this recoding problem by predicting the missing scale of the persons net income in one or the two databases. This solution allows the user to fusion his two databases and finally works with a bigger, unique and synthetic dataset.</strong>
</p>
<p align="justify">
</p>
<p>For the rest of the study, <em>c.neti</em> and <em>c.neti.bis</em> are called the target variables of <em>data1</em> and <em>data2</em> respectively. we deliberately limit this example to the prediction of the variable <em>c.neti.bis</em> in <em>data1</em> but note that the proposed approach would be the same for the prediction of <em>c.neti</em> in <em>data1</em>.</p>

<p> </p>
</div>
<div id="ii--harmonization-of-the-data-sources" class="section level2">
<h2 class="hasAnchor">
<a href="#ii--harmonization-of-the-data-sources" class="anchor"></a>II. Harmonization of the data sources</h2>
<p align="justify">
</p>
<p>Knowing the objective of the study, we first prepare the 2 databases to data fusion. The two functions dedicated to this technique in the <strong>OTrecod</strong> package expect a specific structure of database as argument. The <em>merge_dbs</em> function assists user in this task by:</p>
<ul>
<li>overlaying the two databases</li>
<li>detecting the false shared variables</li>
<li>imputing incomplete information of real shared variables if desired.</li>
</ul>
For this, we fill in the arguments of the <em>merge_dbs</em> function by declaring as follows, the column indexes of all the ordinal variables in <em>data1</em> and <em>data2</em> (including the target variables indexes). Here is no need to handle missing information cecause all the shared variables are complete, but note that it exists a specific argument (<em>impute</em>) in the function to take them into account when necessary.

<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">db_test</span>  <span class="op">=</span> <span class="fu"><a href="../reference/merge_dbs.html">merge_dbs</a></span><span class="op">(</span><span class="va">data1</span>, <span class="va">data2</span>, NAME_Y <span class="op">=</span> <span class="st">"c.neti"</span>, NAME_Z <span class="op">=</span> <span class="st">"c.neti.bis"</span>,
                     ordinal_DB1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">7</span><span class="op">)</span>, ordinal_DB2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,<span class="fl">6</span>,<span class="fl">9</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; DBS MERGING in progress. Please wait ... </span>
<span class="co">#&gt; Y </span>
<span class="co">#&gt; Z </span>
<span class="co">#&gt; DBS MERGING OK </span>
<span class="co">#&gt; -----------------------</span>
<span class="co">#&gt; SUMMARY OF DBS MERGING: </span>
<span class="co">#&gt; Nb of removed subjects because of NA on targets: 0 ( 0 %) </span>
<span class="co">#&gt; Nb of covariates removed because of differences between the 2 bases: 1 </span>
<span class="co">#&gt; Nb of covariates remained: 5 </span>
<span class="co">#&gt; Imputation on incomplete covariates: NO</span>

<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">db_test</span><span class="op">)</span>
<span class="co">#&gt;               Length Class      Mode     </span>
<span class="co">#&gt; DB_READY      8      data.frame list     </span>
<span class="co">#&gt; ID1_drop      0      -none-     character</span>
<span class="co">#&gt; ID2_drop      0      -none-     character</span>
<span class="co">#&gt; Y_LEVELS      7      -none-     character</span>
<span class="co">#&gt; Z_LEVELS      4      -none-     character</span>
<span class="co">#&gt; REMOVE1       1      -none-     character</span>
<span class="co">#&gt; REMOVE2       0      -none-     NULL     </span>
<span class="co">#&gt; REMAINING_VAR 5      -none-     character</span>
<span class="co">#&gt; IMPUTE_TYPE   1      -none-     character</span>
<span class="co">#&gt; DB1_raw       8      data.frame list     </span>
<span class="co">#&gt; DB2_raw       9      data.frame list     </span>
<span class="co">#&gt; SEED          1      -none-     numeric</span>

<span class="va">db_test</span><span class="op">$</span><span class="va">REMAINING_VAR</span>
<span class="co">#&gt; [1] "hsize5"  "marital" "sex"     "urb"     "ww"</span>

<span class="va">db_test</span><span class="op">$</span><span class="va">REMOVE1</span>
<span class="co">#&gt; [1] "age"</span>

<span class="va">db_test</span><span class="op">$</span><span class="va">REMOVE2</span>
<span class="co">#&gt; NULL</span>

<span class="va">db_test</span><span class="op">$</span><span class="va">ID1_drop</span>; <span class="va">db_test</span><span class="op">$</span><span class="va">ID2_drop</span>
<span class="co">#&gt; character(0)</span>
<span class="co">#&gt; character(0)</span>

<span class="va">db_test</span><span class="op">$</span><span class="va">DB_READY</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">201</span><span class="op">:</span><span class="fl">205</span><span class="op">)</span>,<span class="op">]</span>   <span class="co"># The 5 1st subjects of the two databases </span>
<span class="co">#&gt;       DB        Y    Z hsize5 marital sex urb        ww</span>
<span class="co">#&gt; 21384  1   (0,10] &lt;NA&gt;      1       3   2   1 3591.8939</span>
<span class="co">#&gt; 35973  1  (10,15] &lt;NA&gt;      2       2   1   1  415.1592</span>
<span class="co">#&gt; 11774  1  (15,20] &lt;NA&gt;      1       3   1   2 2735.4029</span>
<span class="co">#&gt; 32127  1  (10,15] &lt;NA&gt;      2       2   1   1 1239.5086</span>
<span class="co">#&gt; 6301   1 (-Inf,0] &lt;NA&gt;    &gt;=5       1   1   2 5362.7588</span>
<span class="co">#&gt; 39565  2     &lt;NA&gt;    1      2       2   2   3 1129.2739</span>
<span class="co">#&gt; 36490  2     &lt;NA&gt;    2    &gt;=5       3   1   1 3082.3314</span>
<span class="co">#&gt; 27529  2     &lt;NA&gt;    2      2       2   1   2 2433.0201</span>
<span class="co">#&gt; 201    2     &lt;NA&gt;    2      4       1   1   2 1869.2859</span>
<span class="co">#&gt; 31375  2     &lt;NA&gt;    3      2       2   1   2 2125.3614</span></code></pre></div>
<p align="justify">
</p>
<p>In output:</p>
<ul>
<li>The <em>REMAINING_VAR</em> object gives the identity of the shared variables kept for the merging of the two databases.</li>
<li>The <em>REMOVE1</em> object gives the identity of potential shared variables dropped because of dicrepancies of types: the variable <em>age</em> stored as factor in <em>data1</em> and as numeric in <em>data2</em> is in this case. Sometimes it is possible to reconciliate the two encodings a posteriori, sometime not. Here it would be possible to categorize the variable <em>age</em> in <em>data2</em> in the same way as <em>age</em> in <em>data1</em> but we decide for the example to discard it for the rest of the study.</li>
<li>The <em>REMOVE2</em> object is null, and this result means that there is no factor dropped because of discrepancies of levels.</li>
<li>The <em>ID1_drop</em> and <em>ID2_drop</em> objects are null which means that the target variables <em>c.neti</em> and <em>c.neti.bis</em> have no missing values in there respective databases.</li>
<li>Finally the <em>DB_READY</em> object provides users a synthetic database that overlays <em>data1</em> and <em>data2</em> (in this order) where the <em>DB</em> variable is the database identifier.</li>
</ul>
The variable <em>Y</em> now corresponds to the target variable <em>c.neti</em> with its specific encoding in <em>data1</em> and missing values in <em>data2</em>. In the same way, the variable <em>Z</em> corresponds to <em>c.neti.bis</em>. This database have the structure expected as argument of the <strong>OT_outcome</strong> and <strong>OT_joint</strong> functions.

<p> </p>
</div>
<div id="iii--selection-of-the-matching-variables" class="section level2">
<h2 class="hasAnchor">
<a href="#iii--selection-of-the-matching-variables" class="anchor"></a>III. Selection of the matching variables</h2>
<p align="justify">
Among the set of shared variables kept in the output <em>DB.READY</em> database of the <strong>merge_dbs</strong>, it is important to discard those that never appear not good predictors of the persons net income whatever the considered database. The subset of remaining variables will be the matching variables. This selection of matching variables can be done using the <em>select_pred</em> function of the package.
</p>
<p align="justify">
</p>
<p>This function proposes two levels of study to conclude:</p>
<ul>
<li>When the sample of shared variables is small, standard correlation studies are often enough to select the best set of predictors and get rid of potential multicolinearities between the candidates.</li>
<li>When the conclusion of the first part appears not so clear, this study can be completed by a random forest (RF) process of selection (see <em>RF</em> argument). This part is notably particularly convenient when the sample of covariates is large. The function proposes two random forest procedures: The standard RF which estimates the permutation importance criterion of each shared variable and the conditional importance measures from the <em>proxy</em> package ((4)).</li>
</ul>
At this step, the choice of the recoding algorithm (see (2)) to use a posteriori must be anticipated in the handling of the potential numeric shared variables (In this example, the <em>ww</em> variable is the only one concerned. Indeed, if the <strong>OT_outcome</strong> function runs whatever the type considered, this is not the case of the actual version of the <strong>OT_joint</strong> version which not allows the numeric variable. For this vignette we will test the two algorithms, so we decide to transform <em>ww</em> as categorial using the quartiles of its distribution as thresholds of the four classes. This transformation can be dealt by standard R function (like <em>cut()</em>) or directly in the functions using the <em>convert_num</em> and <em>convert_clss</em> arguments dedicated to this task.

<p align="justify">
The selection of the best predictors of the persons net income must be done in the two databases separately but the <em>selec_pred</em> functions allowed overlayed databases as arguments using the following code:
</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># for data1</span>
<span class="va">test_DB1</span> <span class="op">=</span> <span class="fu"><a href="../reference/select_pred.html">select_pred</a></span><span class="op">(</span><span class="va">db_test</span><span class="op">$</span><span class="va">DB_READY</span>,Y <span class="op">=</span> <span class="st">"Y"</span>, Z <span class="op">=</span> <span class="st">"Z"</span>, ID <span class="op">=</span> <span class="fl">1</span>, OUT <span class="op">=</span> <span class="st">"Y"</span>,
                       quanti <span class="op">=</span> <span class="fl">8</span>, nominal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">5</span><span class="op">:</span><span class="fl">6</span>,<span class="fl">7</span><span class="op">)</span>, ordinal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>,
                       convert_num <span class="op">=</span> <span class="fl">8</span>, convert_clss <span class="op">=</span> <span class="fl">4</span>,
                       thresh_cat <span class="op">=</span> <span class="fl">0.30</span>, thresh_num <span class="op">=</span> <span class="fl">0.70</span>, thresh_Y <span class="op">=</span> <span class="fl">0.10</span>,
                       RF <span class="op">=</span> <span class="cn">TRUE</span>, RF_SEED <span class="op">=</span> <span class="fl">3017</span><span class="op">)</span>
<span class="co">#&gt; The select_pred function is running. Please wait ... </span>
<span class="co">#&gt; Risks of collinearity between predictors detected. Consult outputs for more details ...</span>

<span class="co"># for data2</span>
<span class="va">test_DB2</span> <span class="op">=</span> <span class="fu"><a href="../reference/select_pred.html">select_pred</a></span><span class="op">(</span><span class="va">db_test</span><span class="op">$</span><span class="va">DB_READY</span>,Y <span class="op">=</span> <span class="st">"Y"</span>, Z <span class="op">=</span> <span class="st">"Z"</span>, ID <span class="op">=</span> <span class="fl">1</span>, OUT <span class="op">=</span> <span class="st">"Z"</span>,
                       quanti <span class="op">=</span> <span class="fl">8</span>, nominal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">5</span><span class="op">:</span><span class="fl">6</span>,<span class="fl">7</span><span class="op">)</span>, ordinal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>,
                       convert_num <span class="op">=</span> <span class="fl">8</span>, convert_clss <span class="op">=</span> <span class="fl">4</span>,
                       thresh_cat <span class="op">=</span> <span class="fl">0.30</span>, thresh_num <span class="op">=</span> <span class="fl">0.70</span>, thresh_Y <span class="op">=</span> <span class="fl">0.10</span>,
                       RF <span class="op">=</span> <span class="cn">TRUE</span>, RF_SEED <span class="op">=</span> <span class="fl">3017</span><span class="op">)</span>
<span class="co">#&gt; The select_pred function is running. Please wait ... </span>
<span class="co">#&gt; Risks of collinearity between predictors detected. Consult outputs for more details ...</span></code></pre></div>
<p align="justify">
</p>
<p>As input:</p>
<ul>
<li>The <em>OUT</em> argument specifies the target variable to predict.</li>
<li>The <em>thresh_cat</em> argument corresponds to the threshold of the V Cramer coefficient (for the categorical variables) .</li>
<li>The <em>thresh_num</em> argument corresponds to the threshold of the Spearman correlation coefficient (for the continuous and ordinal variables). Under these values, two shared variables present acceptable colinearities. Under these values, a shared variable is not considered as a good predictor of a target variable.</li>
<li>The <em>thresh_Y</em> argument is reserved to random forest procedures. It corresponds to an acceptability threshold related to the importance mesure criterions. Variables with a cumulative percent of importance measures less than this threshold will be dropped from the final list of RF predictors.
</li>
</ul>
<p align="justify">
Notice that it is important to keep the same arguments in the two selections (<em>test_DB1</em> and <em>test_DB2</em>) for an optimal comparability. Here the standard RF process is used, and the <em>ww</em> variable is converted in categorical type before the selection using <em>convert_num</em>.
</p>
<p>Let see the result for <em>data1</em>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">test_DB1</span><span class="op">)</span>
<span class="co">#&gt;               Length Class      Mode     </span>
<span class="co">#&gt; seed          1      -none-     numeric  </span>
<span class="co">#&gt; outc          1      -none-     character</span>
<span class="co">#&gt; thresh        3      -none-     numeric  </span>
<span class="co">#&gt; convert_num   1      -none-     character</span>
<span class="co">#&gt; DB_USED       8      data.frame list     </span>
<span class="co">#&gt; vcrm_OUTC_cat 5      data.frame list     </span>
<span class="co">#&gt; cor_OUTC_num  5      data.frame list     </span>
<span class="co">#&gt; vcrm_X_cat    5      data.frame list     </span>
<span class="co">#&gt; cor_X_num     5      data.frame list     </span>
<span class="co">#&gt; FG_test       3      -none-     numeric  </span>
<span class="co">#&gt; collinear_PB  2      -none-     list     </span>
<span class="co">#&gt; drop_var      1      -none-     character</span>
<span class="co">#&gt; RF_PRED       4      -none-     numeric  </span>
<span class="co">#&gt; RF_best       2      -none-     character</span>

<span class="va">test_DB1</span><span class="op">$</span><span class="va">vcrm_OUTC_cat</span>
<span class="co">#&gt;   name1   name2 V_Cramer CorrV_Cramer   N</span>
<span class="co">#&gt; 4     Y     sex   0.4384       0.4036 200</span>
<span class="co">#&gt; 3     Y marital   0.2452       0.1740 200</span>
<span class="co">#&gt; 5     Y     urb   0.1703       0.0000 200</span>
<span class="co">#&gt; 2     Y  hsize5   0.1634       0.0000 200</span>
<span class="co">#&gt; 6     Y      ww   0.1465       0.0000 200</span>

<span class="va">test_DB1</span><span class="op">$</span><span class="va">collinear_PB</span>
<span class="co">#&gt; $VCRAM</span>
<span class="co">#&gt;     name1   name2 V_Cramer CorrV_Cramer   N</span>
<span class="co">#&gt; 21 hsize5 marital   0.5038       0.4858 200</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $SPEARM</span>
<span class="co">#&gt; [1] name1       name2       ABS_COR     pv_COR_test N          </span>
<span class="co">#&gt; &lt;0 rows&gt; (or 0-length row.names)</span>

<span class="co"># Results from RF</span>
<span class="va">test_DB1</span><span class="op">$</span><span class="va">drop_var</span>
<span class="co">#&gt; [1] "marital"</span>

<span class="va">test_DB1</span><span class="op">$</span><span class="va">RF_PRED</span>
<span class="co">#&gt;     sex  hsize5     urb      ww </span>
<span class="co">#&gt; 86.8886  7.9677  5.1437  0.0000</span></code></pre></div>
<p align="justify">
In the set of shared variables, all variables are now categorical (factors or ordered factors). According to the <em>vcrm_OUTC_cat</em> output object, the best predictors of <em>c.neti</em> are: <em>sex</em>, <em>marital</em>, <em>urb</em>, <em>hsize5</em>, and <em>ww</em> in that order. Nevertheless, a risk of collinearity is detected between <em>marital</em> and <em>hsize5</em>. The RF process finally suggests to drop <em>marital</em> and to keep only <em>sex</em>, <em>hsize5</em> and eventually <em>urb</em> as matching variables.
</p>
<p>Let see the result for <em>data2</em>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">test_DB2</span><span class="op">)</span>
<span class="co">#&gt;               Length Class      Mode     </span>
<span class="co">#&gt; seed          1      -none-     numeric  </span>
<span class="co">#&gt; outc          1      -none-     character</span>
<span class="co">#&gt; thresh        3      -none-     numeric  </span>
<span class="co">#&gt; convert_num   1      -none-     character</span>
<span class="co">#&gt; DB_USED       8      data.frame list     </span>
<span class="co">#&gt; vcrm_OUTC_cat 5      data.frame list     </span>
<span class="co">#&gt; cor_OUTC_num  5      data.frame list     </span>
<span class="co">#&gt; vcrm_X_cat    5      data.frame list     </span>
<span class="co">#&gt; cor_X_num     5      data.frame list     </span>
<span class="co">#&gt; FG_test       3      -none-     numeric  </span>
<span class="co">#&gt; collinear_PB  2      -none-     list     </span>
<span class="co">#&gt; drop_var      1      -none-     character</span>
<span class="co">#&gt; RF_PRED       4      -none-     numeric  </span>
<span class="co">#&gt; RF_best       2      -none-     character</span>

<span class="va">test_DB2</span><span class="op">$</span><span class="va">vcrm_OUTC_cat</span>
<span class="co">#&gt;   name1   name2 V_Cramer CorrV_Cramer   N</span>
<span class="co">#&gt; 4     Z     sex   0.4783       0.4583 150</span>
<span class="co">#&gt; 2     Z  hsize5   0.2343       0.1693 150</span>
<span class="co">#&gt; 3     Z marital   0.1828       0.1160 150</span>
<span class="co">#&gt; 5     Z     urb   0.1386       0.0000 150</span>
<span class="co">#&gt; 6     Z      ww   0.0949       0.0000 150</span>

<span class="va">test_DB2</span><span class="op">$</span><span class="va">collinear_PB</span>
<span class="co">#&gt; $VCRAM</span>
<span class="co">#&gt;     name1   name2 V_Cramer CorrV_Cramer   N</span>
<span class="co">#&gt; 21 hsize5 marital   0.3555       0.3177 150</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $SPEARM</span>
<span class="co">#&gt; [1] name1       name2       ABS_COR     pv_COR_test N          </span>
<span class="co">#&gt; &lt;0 rows&gt; (or 0-length row.names)</span>

<span class="co"># Results from RF</span>
<span class="va">test_DB2</span><span class="op">$</span><span class="va">drop_var</span>
<span class="co">#&gt; [1] "marital"</span>

<span class="va">test_DB2</span><span class="op">$</span><span class="va">RF_PRED</span>
<span class="co">#&gt;     sex  hsize5      ww     urb </span>
<span class="co">#&gt; 86.1852 13.1555  0.6593  0.0000</span></code></pre></div>
<p align="justify">
According to the <em>vcrm_OUTC_cat</em> output object, the best predictors of <em>c.neti.bis</em> are: <em>sex</em>, <em>hsize5</em>, <em>marital</em>, <em>urb</em>, and <em>ww</em> in that order. A risk of collinearity is also detected between <em>marital</em> and <em>hsize5</em>. The RF process here suggests to drop <em>marital</em> and to keep only <em>sex</em>, <em>hsize5</em> as matching variables.
</p>
<p align="justify">
</p>
<p><strong>In conclusion:</strong></p>
<ul>
<li>The variables <em>sex</em> and <em>hsize5</em> are the best predictors of the target variables in the two databases.</li>
<li>The variable <em>marital</em> is dropped in the two tests because of risks of multicollinearity with <em>hsize5</em>.</li>
<li>The variable <em>ww</em> is never a good predictor of the target information.</li>
<li>The variable <em>urb</em> is an acceptable predictor in the first database only.
</li>
</ul>
<p>The matching variable groups can be:</p>
<ul>
<li>
<em>sex</em>, <em>hsize5</em>
</li>
<li>
<em>sex</em>, <em>hsize5</em>, and <em>urb</em>
</li>
</ul>
<p align="justify">
<strong>We finally keep the last group and dropped the other ones for the rest of the example.</strong>
</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">match_var</span> <span class="op">=</span> <span class="va">db_test</span><span class="op">$</span><span class="va">DB_READY</span><span class="op">[</span>,<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">8</span><span class="op">)</span><span class="op">]</span>
<span class="va">match_var</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">201</span><span class="op">:</span><span class="fl">205</span><span class="op">)</span>,<span class="op">]</span>
<span class="co">#&gt;       DB        Y    Z hsize5 sex urb</span>
<span class="co">#&gt; 21384  1   (0,10] &lt;NA&gt;      1   2   1</span>
<span class="co">#&gt; 35973  1  (10,15] &lt;NA&gt;      2   1   1</span>
<span class="co">#&gt; 11774  1  (15,20] &lt;NA&gt;      1   1   2</span>
<span class="co">#&gt; 32127  1  (10,15] &lt;NA&gt;      2   1   1</span>
<span class="co">#&gt; 6301   1 (-Inf,0] &lt;NA&gt;    &gt;=5   1   2</span>
<span class="co">#&gt; 39565  2     &lt;NA&gt;    1      2   2   3</span>
<span class="co">#&gt; 36490  2     &lt;NA&gt;    2    &gt;=5   1   1</span>
<span class="co">#&gt; 27529  2     &lt;NA&gt;    2      2   1   2</span>
<span class="co">#&gt; 201    2     &lt;NA&gt;    2      4   1   2</span>
<span class="co">#&gt; 31375  2     &lt;NA&gt;    3      2   1   2</span></code></pre></div>
<p><strong>This overlayed database is now ready for recoding.</strong></p>
<p> </p>
</div>
<div id="iv--predicting-the-missing-scales-in-the-databases" class="section level2">
<h2 class="hasAnchor">
<a href="#iv--predicting-the-missing-scales-in-the-databases" class="anchor"></a>IV. Predicting the missing scales in the databases</h2>
<p align="justify">
The <strong>OTrecod</strong> package proposes actually two algorithms using optimal transportation theory (see (3) for details) to solve the recoding problem previously introduced. Each algorithm is stored in a unique function called <strong>OT_outcome</strong> and <strong>OT_joint</strong>. These two functions can predict the missing values of <em>c.neti</em> in <em>data2</em>, the missing values of <em>c.neti.bis</em> in <em>data1</em> or the both using a same argument called <em>which.DB</em>.
</p>
<p align="justify">
As with the <em>select_pred</em> function, it is possible to transform directly the continuous matching variables if necessary using the <em>convert_num</em> and <em>convert_clss</em> arguments.
</p>
<p>Let see the R approach for the prediction of <em>c.neti.bis</em> in <em>data1</em>.</p>
<p> </p>
<div id="a-transporting-target-variables-to-predict-the-missing-scales" class="section level3">
<h3 class="hasAnchor">
<a href="#a-transporting-target-variables-to-predict-the-missing-scales" class="anchor"></a>A) Transporting target variables to predict the missing scales</h3>
<p align="justify">
The algorithm from <strong>OT_outcome</strong> function solves an optimization problem to transfer the distributions of the target variables (or outcome) from one database to another. Using this result, the initial version of the algorithm (see (2)) transfers the distribution of <em>c.neti.bis</em> in <em>data2</em> to the distribution of <em>c.neti.bis</em> in <em>data1</em>, and (inversely for <em>c.neti</em> if necessary). The the algorithm executes in another distinct step, a nearest neighbor procedure to affect the indidividual predictions of <em>c.neti.bis</em> in <em>data1</em>. This algorithm is actually available by writing <em>method = “sequential”</em> as argument of the <em>OT_outcome</em> function.
</p>
<p align="justify">
The algorithm assumes the strong hypothesis that the variable <em>c.neti.bis</em> has the same distribution in <em>data1</em> and <em>data2</em> (and so on for the variable <em>c.neti</em>). If in this example, by construction, this hypothesis is obviously verified, there are also several contexts where this latter no longer holds.
</p>
<p align="justify">
Enrichments have been thus proposed (see (2) to relax this hypothesis (via the <em>maxrelax</em> argument of <strong>OT_outcome</strong>) and directly provides the individual predictions without using the nearest neighbor process. This algorithm is actually available by writing <em>method = “optimal”</em> as argument of the <strong>OT_outcome</strong> function. For our example, the corresponding R code for the prediction of <em>c.neti.bis</em> in <em>data1</em> is:
</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># sequential algorithm</span>
<span class="va">mod1_seq</span> <span class="op">=</span> <span class="fu"><a href="../reference/OT_outcome.html">OT_outcome</a></span><span class="op">(</span><span class="va">match_var</span>, nominal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">5</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span>, ordinal <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">4</span>, dist.choice <span class="op">=</span> <span class="st">"E"</span>, 
                      maxrelax <span class="op">=</span> <span class="fl">0</span> , indiv.method <span class="op">=</span> <span class="st">"sequential"</span>, which.DB <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span>
<span class="co">#&gt; --------------------------------------- </span>
<span class="co">#&gt; OT PROCEDURE in progress ... </span>
<span class="co">#&gt; --------------------------------------- </span>
<span class="co">#&gt; Type                     =  OUTCOME </span>
<span class="co">#&gt; Distance                 =  Euclidean </span>
<span class="co">#&gt; Percent closest knn      =  100 % </span>
<span class="co">#&gt; Relaxation parameter     =  NO </span>
<span class="co">#&gt; Relaxation value         =  0 </span>
<span class="co">#&gt; Individual pred process  =  Sequential </span>
<span class="co">#&gt; DB imputed               =  A </span>
<span class="co">#&gt; ---------------------------------------</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mod1_seq</span><span class="op">)</span>
<span class="co">#&gt;             Length Class      Mode   </span>
<span class="co">#&gt; time_exe      1    difftime   numeric</span>
<span class="co">#&gt; gamma_A      28    -none-     numeric</span>
<span class="co">#&gt; gamma_B      28    -none-     numeric</span>
<span class="co">#&gt; profile       5    data.frame list   </span>
<span class="co">#&gt; res_prox     16    -none-     list   </span>
<span class="co">#&gt; estimatorZA 812    -none-     numeric</span>
<span class="co">#&gt; estimatorYB   0    -none-     NULL   </span>
<span class="co">#&gt; DATA1_OT      8    data.frame list   </span>
<span class="co">#&gt; DATA2_OT      7    data.frame list</span>

<span class="co"># optimal algorithm with no relaxation term</span>
<span class="va">mod2_opt</span> <span class="op">=</span> <span class="fu"><a href="../reference/OT_outcome.html">OT_outcome</a></span><span class="op">(</span><span class="va">match_var</span>, nominal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">5</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span>, ordinal <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">4</span>, dist.choice <span class="op">=</span> <span class="st">"E"</span>, 
                      maxrelax <span class="op">=</span> <span class="fl">0</span>, indiv.method <span class="op">=</span> <span class="st">"optimal"</span>, which.DB <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span>
<span class="co">#&gt; --------------------------------------- </span>
<span class="co">#&gt; OT PROCEDURE in progress ... </span>
<span class="co">#&gt; --------------------------------------- </span>
<span class="co">#&gt; Type                     =  R-OUTCOME </span>
<span class="co">#&gt; Distance                 =  Euclidean </span>
<span class="co">#&gt; Percent closest knn      =  100 % </span>
<span class="co">#&gt; Relaxation parameter     =  NO </span>
<span class="co">#&gt; Relaxation value         =  0 </span>
<span class="co">#&gt; Individual pred process  =  Optimal </span>
<span class="co">#&gt; DB imputed               =  A </span>
<span class="co">#&gt; ---------------------------------------</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">mod2_opt</span><span class="op">$</span><span class="va">profile</span><span class="op">)</span>
<span class="co">#&gt;        ID sex_2 urb_2 urb_3 hsize5</span>
<span class="co">#&gt; 21384 P_1     1     0     0      1</span>
<span class="co">#&gt; 35973 P_2     0     0     0      2</span>
<span class="co">#&gt; 11774 P_3     0     1     0      1</span>
<span class="co">#&gt; 6301  P_4     0     1     0      5</span>
<span class="co">#&gt; 12990 P_5     1     1     0      2</span>
<span class="co">#&gt; 39835 P_6     1     1     0      4</span>

<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">mod2_opt</span><span class="op">$</span><span class="va">profile</span><span class="op">)</span>
<span class="co">#&gt; [1] 29  5</span>

<span class="va">mod2_opt</span><span class="op">$</span><span class="va">gamma_A</span>
<span class="co">#&gt;       [,1]  [,2]       [,3]        [,4]</span>
<span class="co">#&gt; [1,] 0.185 0.000 0.00000000 0.000000000</span>
<span class="co">#&gt; [2,] 0.200 0.000 0.00000000 0.000000000</span>
<span class="co">#&gt; [3,] 0.015 0.155 0.00000000 0.000000000</span>
<span class="co">#&gt; [4,] 0.000 0.225 0.02000000 0.000000000</span>
<span class="co">#&gt; [5,] 0.000 0.000 0.09000000 0.000000000</span>
<span class="co">#&gt; [6,] 0.000 0.000 0.06333333 0.001666667</span>
<span class="co">#&gt; [7,] 0.000 0.000 0.00000000 0.045000000</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">mod2_opt</span><span class="op">$</span><span class="va">DATA1_OT</span><span class="op">)</span>
<span class="co">#&gt;       DB        Y    Z sex_2 urb_2 urb_3 hsize5 OTpred</span>
<span class="co">#&gt; 21384  1   (0,10] &lt;NA&gt;     1     0     0      1      1</span>
<span class="co">#&gt; 35973  1  (10,15] &lt;NA&gt;     0     0     0      2      2</span>
<span class="co">#&gt; 11774  1  (15,20] &lt;NA&gt;     0     1     0      1      2</span>
<span class="co">#&gt; 32127  1  (10,15] &lt;NA&gt;     0     0     0      2      2</span>
<span class="co">#&gt; 6301   1 (-Inf,0] &lt;NA&gt;     0     1     0      5      1</span>
<span class="co">#&gt; 12990  1 (-Inf,0] &lt;NA&gt;     1     1     0      2      1</span></code></pre></div>
<p>As input:</p>
<ul>
<li>The target <em>c.neti.bis</em> is here considered as an ordinal scale but sometimes this information can be unknown: In the situation where there is no information about the encoding, is recommended to consider it as nominal.</li>
<li>There is many possible distance functions integrated in <strong>OT_outcome</strong> to evaluate the distances between individuals: Here, the Euclidean distance have been chosen.</li>
<li>The <em>percent.knn</em> argument corresponds to the fixed part (from 0 to 1) of individuals that participate to the computations of average distances between levels of target variables.</li>
</ul>
<p>In output, these two models provides lists of same structure:</p>
<ul>
<li>
<em>gamma_A</em> stores the solution of the optimization problem to determine the missing scales of <em>c.neti.bis</em> in <em>data1</em>.</li>
<li>The <em>profile</em> object gives the profiles of covariates detected by the algorithm from the two databases: Here we have 29 profiles.</li>
<li>
<em>estimatorZA</em> is an array that provides for each profile, the probability for <em>c.neti.bis</em> to belong to a given level knowing the covariates and the corresponding level of <em>c.neti</em>.</li>
<li>The <em>DATA1_OT</em> object provides the individual predictions of <em>c.neti.bis</em> in <em>data1</em> (variable <em>OTpred</em> of the data.frame).</li>
</ul>
<p> </p>
</div>
<div id="b-transporting-target-and-shared-variables-to-predict-the-missing-scales" class="section level3">
<h3 class="hasAnchor">
<a href="#b-transporting-target-and-shared-variables-to-predict-the-missing-scales" class="anchor"></a>B) Transporting target and shared variables to predict the missing scales</h3>
<p align="justify">
The objective of the algorithm integrated in the <strong>OT_joint</strong> function is the same as that of the <strong>OT_outcome</strong> function, but unlike <strong>OT_outcome</strong> transfers only the distributions of the target variables to solve the optimization problem, the <strong>OT_joint</strong> function now transports the joint distribution of outcomes and covariates: This approach makes it possible to no longer assumes the strong distributional hypothesis mentionned previously.
</p>
<p align="justify">
Nevertheless, as with the <strong>OT_outcome</strong> function, enrichments have been proposed (see (2) to relax distributional constraints (see <em>maxrelax</em> argument) and eventually adds to the algorithm a regularization term to smooth the variations of target variables with respect to matching variables (see <em>lambda.reg</em> arguments).
</p>
<p align="justify">
</p>
<p>To guarantee the convergence of the algorithm:</p>
<ul>
<li>It is suggested to work with a limited number of matching variables and so to select them rigouresly using <em>select_pred</em> or another process of selection.</li>
<li>Choosing a small value of the <em>prox.X</em> argument improves the convergence and the running time of the function.</li>
</ul>
For our example, the corresponding R code for the prediction of <em>c.neti.bis</em> in <em>data1</em> is:

<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Algorithms with no enrichments</span>
<span class="va">mod3_joint</span> <span class="op">=</span> <span class="fu"><a href="../reference/OT_joint.html">OT_joint</a></span><span class="op">(</span><span class="va">match_var</span>, nominal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">5</span><span class="op">)</span>, ordinal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span>,<span class="fl">6</span><span class="op">)</span>, dist.choice <span class="op">=</span> <span class="st">"E"</span>, which.DB <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span>
<span class="co">#&gt; --------------------------------------- </span>
<span class="co">#&gt; OT JOINT PROCEDURE in progress ... </span>
<span class="co">#&gt; --------------------------------------- </span>
<span class="co">#&gt; Type                  =  JOINT </span>
<span class="co">#&gt; Distance              =  Euclidean </span>
<span class="co">#&gt; Percent closest       =  100 % </span>
<span class="co">#&gt; Relaxation term       =  0 </span>
<span class="co">#&gt; Regularization term   =  0 </span>
<span class="co">#&gt; Aggregation tol cov   =  0.1 </span>
<span class="co">#&gt; DB imputed            =  A </span>
<span class="co">#&gt; ---------------------------------------</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mod3_joint</span><span class="op">)</span>
<span class="co">#&gt;             Length Class      Mode   </span>
<span class="co">#&gt; time_exe      1    difftime   numeric</span>
<span class="co">#&gt; gamma_A      28    -none-     numeric</span>
<span class="co">#&gt; gamma_B       0    -none-     NULL   </span>
<span class="co">#&gt; profile       4    data.frame list   </span>
<span class="co">#&gt; res_prox     16    -none-     list   </span>
<span class="co">#&gt; estimatorZA 812    -none-     numeric</span>
<span class="co">#&gt; estimatorYB   0    -none-     NULL   </span>
<span class="co">#&gt; DATA1_OT      7    data.frame list   </span>
<span class="co">#&gt; DATA2_OT      6    data.frame list</span></code></pre></div>
<p align="justify">
For a better understanding, the input arguments and output objects of the <strong>OT_joint</strong> function have been thought to be similar to those proposed by the <strong>OT_outcome</strong> function. As previously, the <em>OTpred</em> variable of the <em>DATA1_OT</em> object stores the individual predictions of <em>c.neti.bis</em> in <em>data1</em>.
</p>
<p> </p>
</div>
</div>
<div id="v--validation-of-the-individual-predictions" class="section level2">
<h2 class="hasAnchor">
<a href="#v--validation-of-the-individual-predictions" class="anchor"></a>V. Validation of the individual predictions</h2>
<p align="justify">
The <strong>verif_OT</strong> function gives access to different tools for assessing the reliability of the individual predictions proposed by the <strong>OT_outcome</strong> and <strong>OT_joint</strong> functions.
</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Validation of the mod1_seq model</span>
<span class="va">verif_out1</span> <span class="op">=</span> <span class="fu"><a href="../reference/verif_OT.html">verif_OT</a></span><span class="op">(</span><span class="va">mod1_seq</span>, stab.prob <span class="op">=</span> <span class="cn">TRUE</span>, min.neigb <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="va">verif_out1</span><span class="op">$</span><span class="va">conf.mat</span>
<span class="co">#&gt;            predZ</span>
<span class="co">#&gt; Y             1   2   3   4 Sum</span>
<span class="co">#&gt;   (-Inf,0]   37   0   0   0  37</span>
<span class="co">#&gt;   (0,10]     40   0   0   0  40</span>
<span class="co">#&gt;   (10,15]     3  31   0   0  34</span>
<span class="co">#&gt;   (15,20]     1  45   3   0  49</span>
<span class="co">#&gt;   (20,25]     1   1  16   0  18</span>
<span class="co">#&gt;   (25,35]     1   1  11   0  13</span>
<span class="co">#&gt;   (35, Inf]   1   1   1   6   9</span>
<span class="co">#&gt;   Sum        84  79  31   6 200</span>

<span class="va">verif_out1</span><span class="op">$</span><span class="va">res.prox</span>
<span class="co">#&gt;        N   V_cram rank_cor </span>
<span class="co">#&gt;  200.000    0.860    0.871</span>

<span class="va">verif_out1</span><span class="op">$</span><span class="va">res.stab</span>
<span class="co">#&gt;          N min.N  R  mean    sd</span>
<span class="co">#&gt; 1st DB 200     3 10 0.863 0.147</span>


<span class="co"># Validation of the mod2_seq model</span>
<span class="va">verif_out2</span> <span class="op">=</span> <span class="fu"><a href="../reference/verif_OT.html">verif_OT</a></span><span class="op">(</span><span class="va">mod2_opt</span>, stab.prob <span class="op">=</span> <span class="cn">TRUE</span>, min.neigb <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="va">verif_out2</span><span class="op">$</span><span class="va">conf.mat</span>
<span class="co">#&gt;            predZ</span>
<span class="co">#&gt; Y             1   2   3   4 Sum</span>
<span class="co">#&gt;   (-Inf,0]   37   0   0   0  37</span>
<span class="co">#&gt;   (0,10]     40   0   0   0  40</span>
<span class="co">#&gt;   (10,15]     3  31   0   0  34</span>
<span class="co">#&gt;   (15,20]     0  45   4   0  49</span>
<span class="co">#&gt;   (20,25]     0   0  18   0  18</span>
<span class="co">#&gt;   (25,35]     0   0  13   0  13</span>
<span class="co">#&gt;   (35, Inf]   0   0   0   9   9</span>
<span class="co">#&gt;   Sum        80  76  35   9 200</span>
<span class="va">rate_good_pred</span> <span class="op">=</span> <span class="op">(</span><span class="fl">37</span><span class="op">+</span><span class="fl">40</span><span class="op">+</span><span class="fl">31</span><span class="op">+</span><span class="fl">45</span><span class="op">+</span><span class="fl">18</span><span class="op">+</span><span class="fl">13</span><span class="op">+</span><span class="fl">9</span><span class="op">)</span><span class="op">/</span><span class="fl">200</span>
<span class="va">rate_good_pred</span>
<span class="co">#&gt; [1] 0.965</span>

<span class="va">verif_out2</span><span class="op">$</span><span class="va">res.prox</span>
<span class="co">#&gt;        N   V_cram rank_cor </span>
<span class="co">#&gt;  200.000    0.960    0.939</span>

<span class="va">verif_out2</span><span class="op">$</span><span class="va">res.stab</span>
<span class="co">#&gt;          N min.N  R mean    sd</span>
<span class="co">#&gt; 1st DB 200     3 10 0.93 0.109</span>


<span class="co"># Validation of the mod3_opt model</span>
<span class="va">verif_jt</span>   <span class="op">=</span> <span class="fu"><a href="../reference/verif_OT.html">verif_OT</a></span><span class="op">(</span><span class="va">mod3_joint</span>, stab.prob <span class="op">=</span> <span class="cn">TRUE</span>, min.neigb <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="va">verif_jt</span><span class="op">$</span><span class="va">conf.mat</span>
<span class="co">#&gt;            predZ</span>
<span class="co">#&gt; Y             1   2   3   4 Sum</span>
<span class="co">#&gt;   (-Inf,0]   33   4   0   0  37</span>
<span class="co">#&gt;   (0,10]     32   8   0   0  40</span>
<span class="co">#&gt;   (10,15]     4  29   1   0  34</span>
<span class="co">#&gt;   (15,20]    11  19  19   0  49</span>
<span class="co">#&gt;   (20,25]     0  10   5   3  18</span>
<span class="co">#&gt;   (25,35]     1   2  10   0  13</span>
<span class="co">#&gt;   (35, Inf]   6   1   0   2   9</span>
<span class="co">#&gt;   Sum        87  73  35   5 200</span>

<span class="va">verif_jt</span><span class="op">$</span><span class="va">res.prox</span>
<span class="co">#&gt;        N   V_cram rank_cor </span>
<span class="co">#&gt;  200.000    0.550    0.613</span>

<span class="va">verif_jt</span><span class="op">$</span><span class="va">res.stab</span>
<span class="co">#&gt;          N min.N  R  mean    sd</span>
<span class="co">#&gt; 1st DB 112     3 10 0.904 0.117</span></code></pre></div>
<p align="justify">
</p>
<p>As input:</p>
<ul>
<li>When the <em>stab.prob</em> argument is set to TRUE, the function provides information about the average stability of the individual predictions.</li>
<li>The <em>min.neigb</em> argument specifies that individuals whose probabilities of assignments have been estimated using less than 3 neighbors are dropped from this average (see the documentation of the function for more details).
</li>
</ul>
<p align="justify">
</p>
<p>As output, we have selected the most interesting one to make the comparison between the three tested models:</p>
<ul>
<li>The <em>conf.mat</em> object provides the confusion matrix between <em>c.neti</em> and the individual predictions of <em>c.neti.bis</em> in <em>data1</em>. Here the two target variables <em>c.neti</em> and <em>c.neti.bis</em> are supposed to summarize a same information, so if the two scales are ordered, a clear structure in the confusion matrix traduces a good logical in the prediction. In our example, by construction, we also know the real encoding of <em>c.neti.bis</em>: We can so easily verify that the rate of good predictions equals 0.965 for the <em>mod2_opt</em> model, 0.93 for the <em>mod1_seq</em> model and 0.635 for the <em>mod3_jt</em> model.</li>
<li>Studying the proximity between the distributions of <em>c.neti</em> and <em>c.neti.bis</em> in <em>data1</em> via the V Cramer criterion (see <em>res.prox</em> object) confirms that the <em>mod2_opt</em> model is the more adapted for our example.</li>
<li>Finally, studying the stability of the predictions (see <em>res.stab</em> object) shows good results whatever the considered model.
</li>
</ul>
<strong>OBJECTIVE</strong>
<p align="justify">
<strong>The two first models are here more adapted when the strong distributional hypothesis previously introduced holds.</strong> <strong>Nevertheless, the mod3_jt model could be significantly improved by adding appropriate relaxation and regularization terms, so now, R user,</strong> <strong>try by yourself !</strong>
</p>
<p> </p>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<ol style="list-style-type: decimal">
<li><p>Gares V, Dimeglio C, Guernec G, Fantin F, Lepage B, Korosok MR, savy N. (2019). On the use of optimal transportation theory to recode variables and application to database merging. The International Journal of Biostatistics.Volume 16, Issue 1, 20180106, eISSN 1557-4679- <a href="https://doi.org/10.1515/ijb-2018-0106" class="uri">https://doi.org/10.1515/ijb-2018-0106</a>.</p></li>
<li><p>Gares V, Omer J (2020). Regularized optimal transport of covariates and outcomes in data recoding. Journal of the American Statistical Association, doi: 10.1080/01621459.2020.1775615 - <a href="https://doi.org/10.1080/01621459.2020.1775615" class="uri">https://doi.org/10.1080/01621459.2020.1775615</a>.</p></li>
<li><p>D’Orazio, M (2015). Integration and imputation of survey data in R: the StatMatch package. Romanian Statistical Review, vol. 63(2), pages 57-68</p></li>
<li><p>Strobl C, Boulesteix A-L, Kneib T, Augustin T, Zeileis A (2008). Conditional Variable Importance for Random Forests. BMC Bioinformatics, 9, 307 - (<a href="http://www.biomedcentral.com/1471-2105/9/307" class="uri">http://www.biomedcentral.com/1471-2105/9/307</a>)</p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Gregory Guernec, Valerie Gares.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
